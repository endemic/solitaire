<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Card Dragging Demo</title>

  <style>
    html,
    body {
      margin: 0;
      padding: 0;
      height: 100%;
    }

    body { text-align: center; }

    #game {
      margin: auto;
      background-color: #0a5;
      max-width: 100%;
      max-height: 100%;
      /* TODO: this doesn't seem to work on an actual phone */
      aspect-ratio: 4 / 3;
      cursor: grab;
    }
  </style>
  <script>
    const IMG_SRC = [
      'images/backs/one.png',

      // 'images/hearts/ace.png',
      // 'images/hearts/two.png',
      // 'images/hearts/three.png',
      'images/hearts/four.png',
      // 'images/hearts/five.png',
      // 'images/hearts/six.png',
      // 'images/hearts/seven.png',
      // 'images/hearts/eight.png',
      // 'images/hearts/nine.png',
      // 'images/hearts/ten.png',
      // 'images/hearts/jack.png',
      // 'images/hearts/queen.png',
      // 'images/hearts/king.png',

      // 'images/diamonds/ace.png',
      // 'images/diamonds/two.png',
      // 'images/diamonds/three.png',
      // 'images/diamonds/four.png',
      // 'images/diamonds/five.png',
      // 'images/diamonds/six.png',
      // 'images/diamonds/seven.png',
      // 'images/diamonds/eight.png',
      // 'images/diamonds/nine.png',
      // 'images/diamonds/ten.png',
      // 'images/diamonds/jack.png',
      // 'images/diamonds/queen.png',
      // 'images/diamonds/king.png',

      // 'images/spades/ace.png',
      // 'images/spades/two.png',
      // 'images/spades/three.png',
      // 'images/spades/four.png',
      // 'images/spades/five.png',
      // 'images/spades/six.png',
      // 'images/spades/seven.png',
      // 'images/spades/eight.png',
      // 'images/spades/nine.png',
      // 'images/spades/ten.png',
      // 'images/spades/jack.png',
      // 'images/spades/queen.png',
      // 'images/spades/king.png',

      // 'images/clubs/ace.png',
      // 'images/clubs/two.png',
      // 'images/clubs/three.png',
      // 'images/clubs/four.png',
      // 'images/clubs/five.png',
      // 'images/clubs/six.png',
      // 'images/clubs/seven.png',
      // 'images/clubs/eight.png',
      // 'images/clubs/nine.png',
      // 'images/clubs/ten.png',
      // 'images/clubs/jack.png',
      // 'images/clubs/queen.png',
      // 'images/clubs/king.png',
    ];

    const IMAGES = {};
    let loadedImages = 0;

    const onImageLoad = e => {
      // TODO: display a progress bar or something
      loadedImages += 1;

      // this means we've got all our images in memory
      if (loadedImages === IMG_SRC.length) {
        // TODO: initialize the canvas before this, so a "loading" progress bar can be
        // displayed (or "Loading..." text)
        dragDemo();
      }
    }

    IMG_SRC.forEach(src => {
      // probably a better way to do this
      let key = src.match(/(?<=images\/)\w+\/\w+/)[0].replace('/','_');

      IMAGES[key] = new Image();
      IMAGES[key].src = src;
      IMAGES[key].addEventListener('load', onImageLoad);
    });

    class Card {
      faceUp = false;
      x = 0;
      y = 0;
      backImg = null;
      frontImg = null;
      suite = null;
      rank = null;

      constructor(rank, suite) {
        this.rank = rank;
        this.suite = suite;

        // TODO: pull backImg/frontImg from the list of loaded images
      }
    }

    const dragDemo = e => {
      // do stuff here
      const canvas = document.getElementById('game');
      const context = canvas.getContext('2d');

      // TODO: determine the necessary max width/height based on screenshots of the old game
      // cards are 71x96px
      // margin between cards horizontally is 16px
      // margin between cards vertically is 6px

      // we could do 75x100px cards
      // 10px margin both horizontally & vertically
      // 525px total width of all cards
      // 80px (8 * 10px) horizontal margin

      // 605px max width
      // at 4:3 aspect ratio, that makes height 454px
      // is that a viable size?

      const margin = 10;
      const width = 605;
      const height = 454;
      const cardWidth = 75;
      const cardHeight = 100;

      const stacks = [];

      // draw pile
      stacks.push({
        x: margin,
        y: margin
      });

      // play piles
      for (let i = 0; i < 4; i += 1) {
        stacks.push({
          x: width - (cardWidth * (i + 1)) - (margin * (i + 1)),
          y: margin
        });
      }

      // reference the various places where a card can be played
      for (let i = 0; i < 7; i += 1) {
        stacks.push({
          x: cardWidth * i + (margin * (i + 1)),
          y: cardHeight + margin * 2
        });
      }

      const update = () => {
        context.clearRect(0, 0, width, height);

        // draw stack backgrounds
        stacks.forEach(stack => {
          // `target` is the pile background image
          context.drawImage(target, stack.x, stack.y);
        });

        // draw card
        context.drawImage(cardImg, card.x, card.y);
      };

      // track position of the singular card we can move around
      // eventually we'd store references to all the on-screen cards
      let card = { x: stacks[0].x, y: stacks[0].y };

      // bool whether a card has been picked up or not
      let grabbed = null;

      // record the cursor offset where the card was picked up,
      // so clicking the card doesn't cause it to "jump" to the cursor
      let grabOffset = {x: 0, y: 0};

      // initial draw
      update();

      // rudimentary bounding box intersection
      const touchedStack = ({x, y}) => {
        return stacks.findIndex(stack => {
          return x > stack.x &&
            x < stack.x + cardWidth &&
            y > stack.y &&
            y < stack.y + cardHeight;
        });
      };

      const touchedCard = ({x, y}) => {
        return x > card.x &&
            x < card.x + cardWidth &&
            y > card.y &&
            y < card.y + cardHeight;
      };

      const getCoords = event => {
        // need to scale the touches by the actual size of the canvas;
        // e.g. the canvas still thinks it is 605px wide even if it is
        // scaled to 400px by CSS rules
        const scale = event.target.width / event.target.clientWidth;

        if (event.changedTouches && event.changedTouches.length > 0) {
          return {
            x: event.changedTouches[0].clientX * scale,
            y: event.changedTouches[0].clientY * scale
          };
        }

        // this seems to translate to <canvas> coordinates
        return {
          x: event.x - event.target.offsetLeft,
          y: event.y - event.target.offsetTop
        }
      };

      const onDown = e => {
        e.preventDefault();

        let {x, y} = getCoords(e);

        if (touchedCard({x, y})) {
          canvas.style.cursor = 'grabbing';
          grabbed = card;
          grabOffset = {
            x: x - card.x,
            y: y - card.y
          };
        }
      };

      const onMove = e => {
        e.preventDefault();

        if (!grabbed) {
          return;
        }

        let {x, y} = getCoords(e);

        // move the card along with the touch/cursor
        card = {x: x - grabOffset.x, y: y - grabOffset.y};

        update();
      };

      const onUp = e => {
        e.preventDefault();

        if (!grabbed) {
          return;
        }

        grabbed = null;
        canvas.style.cursor = 'grab';

        let {x, y} = getCoords(e);

        // TODO: check if current position of card overlaps any of the drop zones
        // if so, lock to that location
        const stackIndex = touchedStack({x, y});
        if (stackIndex !== -1) {
          card = {
            x: stacks[stackIndex].x,
            y: stacks[stackIndex].y
          };
        } else {
          // otherwise, move the card back to its original position
          // TEMP: just return card back to the "draw" pile
          card = { x: stacks[0].x, y: stacks[0].y }
        }

        update();
      };

      canvas.addEventListener('mousedown', onDown);
      canvas.addEventListener('mousemove', onMove);
      canvas.addEventListener('mouseup', onUp);

      canvas.addEventListener('touchstart', onDown);
      canvas.addEventListener('touchmove', onMove);
      canvas.addEventListener('touchend', onUp);
    };

    const target = new Image();
    target.src = 'images/target.png';

    const cardImg = new Image();
    cardImg.addEventListener('load', dragDemo);
    cardImg.src = 'images/card.png';
  </script>
</head>
<body>
  <canvas id="game" width="605" height="454"></canvas>
</body>
</html>
